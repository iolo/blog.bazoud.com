<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html lang="fr-FR">
  <head>
    <meta charset="utf-8"/>
    <meta content="text/html;charset=UTF-8" http-equiv="Content-Type"/>
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1"/>
    <meta name="viewport" content="width=device-width"/>
    <meta name="generator" content="Wintersmithq"/>
    <meta name="google-site-verification" content="google36a66ae7f1a82c45"/>
    <meta name="description" content="Le blog d'Olivier"/>
    <meta name="author" content="Olivier Bazoud"/>
    <meta name="keywords" content="geek,web,java,spring,spring batch,spring batch in action,node.js,git,ruby,svn,subversion"/>
    <title>Le blog d'Olivier » Vagrant, créateur de VM
    </title>
    <link rel="apple-touch-icon" href="/ico/bootstrap-apple-57x57.png"/>
    <link rel="apple-touch-icon" sizes="72x72" href="/ico/bootstrap-apple-72x72.png"/>
    <link rel="apple-touch-icon" sizes="114x114" href="/ico/bootstrap-apple-114x114.png"/>
    <link rel="alternate" type="application/rss+xml" title="RSS 2.0" href="http://feeds.feedburner.com/bazoud/feed"/>
    <link rel="alternate" type="text/xml" title="RSS .92" href="http://feeds.feedburner.com/bazoud/rss"/>
    <link rel="alternate" type="application/atom+xml" title="Atom 0.3" href="http://feeds.feedburner.com/bazoud/atom"/>
    <link href="/vendor/bootstrap/bootstrap.min.css" rel="stylesheet"/>
    <link href="/styles/mystyle.css" rel="stylesheet"/>
    <link href="/vendor/bootstrap/prettify.css" type="text/css" rel="stylesheet"/>
    <script type="text/javascript" src="/vendor/google-code-prettify/prettify.js"></script>
    <!-- Shims: IE6-8 support of HTML5 elements--><!--[if lt IE 9]>
    <script async="async" src="http://html5shim.googlecode.com/svn/trunk/html5.js"></script><![endif]-->
  </head>
  <body onload="prettyPrint()">
    <div class="navbar navbar-fixed-top"><a href="http://github.com/obazoud/blog.bazoud.com"><img style="position: absolute; top: 0; right: 0; border: 0;" src="https://a248.e.akamai.net/camo.github.com/30f550e0d38ceb6ef5b81500c64d970b7fb0f028/687474703a2f2f73332e616d617a6f6e6177732e636f6d2f6769746875622f726962626f6e732f666f726b6d655f72696768745f6f72616e67655f6666373630302e706e67" alt="Fork me on GitHub"/></a>
      <div class="navbar-inner">
        <div class="container-fluid"><a data-toggle="collapse" data-target=".nav-collapse" class="btn btn-navbar"><span class="icon-bar"></span><span class="icon-bar"></span><span class="icon-bar"></span></a><a href="/" class="brand">Le blog d'Olivier</a>
          <div class="nav-collapse">
            <form id="search-form" action="http://www.google.com/search" method="get" class="navbar-search pull-left"><span class="glass js-search-action"><i></i></span>
              <input type="hidden" value="UTF-8" name="ie"/>
              <input type="hidden" value="UTF-8" name="oe"/>
              <input type="hidden" value="blog.bazoud.com" name="domains"/>
              <input type="hidden" value="blog.bazoud.com" name="sitesearch"/>
              <input name="q" type="text" placeholder="Rechercher avec Google..." class="search-query span3"/>
            </form>
          </div>
        </div>
      </div>
    </div>
    <div class="container-fluid">
      <div class="row-fluid">
        <div class="span3">
          <div class="well sidebar-nav">
            <ul class="nav nav-list">
              <h4>Suivez moi !</h4><a target="_blank" style="cursor: pointer;" href="http://feeds.feedburner.com/bazoud/feed"><img alt="Feed" title="Feed" src="/images/rss.png"/></a><a href="http://www.twitter.com/obazoud" style="cursor: pointer;" target="_blank"><img src="/images/twitter.png" title="Follow me on Twitter!" alt="Follow @obazoud on Twitter!"/></a><a href="https://plus.google.com/108456051643223740688" target="_blank" alt="Google +" title="Google +"><img src="/images/google-plus-48x48.png" border="0"/></a>
              <h4>Spring Batch in Action</h4><a href="http://affiliate.manning.com/idevaffiliate.php?id=1178_267_1_68" target="_blank" alt="String Batch in Action" title="String Batch in Action"><img border="0" src="/images/SpringBatchInAction.jpg" alt="String Batch in Action" title="String Batch in Action"/></a>
              <h4>Tags</h4>
              <div id="tags" class="tagcloud">
<a href="/tag/ActiveMQ" title="ActiveMQ: 2 posts" class="size-1">ActiveMQ</a>
<a href="/tag/advanced" title="advanced: 1 posts" class="size-0">advanced</a>
<a href="/tag/awk" title="awk: 3 posts" class="size-2">awk</a>
<a href="/tag/bash" title="bash: 3 posts" class="size-2">bash</a>
<a href="/tag/bdd" title="bdd: 1 posts" class="size-0">bdd</a>
<a href="/tag/blog" title="blog: 1 posts" class="size-0">blog</a>
<a href="/tag/chrome" title="chrome: 2 posts" class="size-1">chrome</a>
<a href="/tag/chromium" title="chromium: 1 posts" class="size-0">chromium</a>
<a href="/tag/chtijug" title="chtijug: 1 posts" class="size-0">chtijug</a>
<a href="/tag/cloud" title="cloud: 1 posts" class="size-0">cloud</a>
<a href="/tag/coffeescript" title="coffeescript: 1 posts" class="size-0">coffeescript</a>
<a href="/tag/commons-logging" title="commons-logging: 1 posts" class="size-0">commons-logging</a>
<a href="/tag/decode" title="decode: 1 posts" class="size-0">decode</a>
<a href="/tag/Derby" title="Derby: 1 posts" class="size-0">Derby</a>
<a href="/tag/devops" title="devops: 1 posts" class="size-0">devops</a>
<a href="/tag/docpad" title="docpad: 1 posts" class="size-0">docpad</a>
<a href="/tag/eclipse" title="eclipse: 2 posts" class="size-1">eclipse</a>
<a href="/tag/evenement" title="evenement: 4 posts" class="size-3">evenement</a>
<a href="/tag/firefox" title="firefox: 4 posts" class="size-3">firefox</a>
<a href="/tag/flash" title="flash: 1 posts" class="size-0">flash</a>
<a href="/tag/gem" title="gem: 1 posts" class="size-0">gem</a>
<a href="/tag/generics" title="generics: 4 posts" class="size-3">generics</a>
<a href="/tag/git" title="git: 5 posts" class="size-4">git</a>
<a href="/tag/google" title="google: 2 posts" class="size-1">google</a>
<a href="/tag/grep" title="grep: 2 posts" class="size-1">grep</a>
<a href="/tag/GWT" title="GWT: 7 posts" class="size-5">GWT</a>
<a href="/tag/h2" title="h2: 2 posts" class="size-1">h2</a>
<a href="/tag/heroku" title="heroku: 1 posts" class="size-0">heroku</a>
<a href="/tag/Hibernate" title="Hibernate: 5 posts" class="size-4">Hibernate</a>
<a href="/tag/Hibernate4gwt" title="Hibernate4gwt: 2 posts" class="size-1">Hibernate4gwt</a>
<a href="/tag/java" title="java: 16 posts" class="size-12">java</a>
<a href="/tag/javascript" title="javascript: 1 posts" class="size-0">javascript</a>
<a href="/tag/jdk5" title="jdk5: 5 posts" class="size-4">jdk5</a>
<a href="/tag/jdk6" title="jdk6: 1 posts" class="size-0">jdk6</a>
<a href="/tag/jenkins" title="jenkins: 1 posts" class="size-0">jenkins</a>
<a href="/tag/JMS" title="JMS: 2 posts" class="size-1">JMS</a>
<a href="/tag/linux" title="linux: 1 posts" class="size-0">linux</a>
<a href="/tag/lucid-lynx" title="lucid-lynx: 1 posts" class="size-0">lucid-lynx</a>
<a href="/tag/maven" title="maven: 9 posts" class="size-7">maven</a>
<a href="/tag/nodejs" title="nodejs: 1 posts" class="size-0">nodejs</a>
<a href="/tag/oh-my-zsh" title="oh-my-zsh: 1 posts" class="size-0">oh-my-zsh</a>
<a href="/tag/opschef" title="opschef: 1 posts" class="size-0">opschef</a>
<a href="/tag/Oracle" title="Oracle: 9 posts" class="size-7">Oracle</a>
<a href="/tag/phantomjs" title="phantomjs: 1 posts" class="size-0">phantomjs</a>
<a href="/tag/ppa" title="ppa: 1 posts" class="size-0">ppa</a>
<a href="/tag/puppet" title="puppet: 1 posts" class="size-0">puppet</a>
<a href="/tag/ruby" title="ruby: 2 posts" class="size-1">ruby</a>
<a href="/tag/sed" title="sed: 1 posts" class="size-0">sed</a>
<a href="/tag/shell" title="shell: 6 posts" class="size-4">shell</a>
<a href="/tag/sonar" title="sonar: 1 posts" class="size-0">sonar</a>
<a href="/tag/spring" title="spring: 3 posts" class="size-2">spring</a>
<a href="/tag/springbatch" title="springbatch: 5 posts" class="size-4">springbatch</a>
<a href="/tag/springbatchinaction" title="springbatchinaction: 2 posts" class="size-1">springbatchinaction</a>
<a href="/tag/Stripes" title="Stripes: 2 posts" class="size-1">Stripes</a>
<a href="/tag/subversion" title="subversion: 1 posts" class="size-0">subversion</a>
<a href="/tag/sugfr" title="sugfr: 4 posts" class="size-3">sugfr</a>
<a href="/tag/svn" title="svn: 6 posts" class="size-4">svn</a>
<a href="/tag/svn2git" title="svn2git: 1 posts" class="size-0">svn2git</a>
<a href="/tag/testng" title="testng: 1 posts" class="size-0">testng</a>
<a href="/tag/tomcat" title="tomcat: 3 posts" class="size-2">tomcat</a>
<a href="/tag/twitter" title="twitter: 2 posts" class="size-1">twitter</a>
<a href="/tag/Ubuntu" title="Ubuntu: 38 posts" class="size-25">Ubuntu</a>
<a href="/tag/Uncategorized" title="Uncategorized: 4 posts" class="size-3">Uncategorized</a>
<a href="/tag/vagrant" title="vagrant: 1 posts" class="size-0">vagrant</a>
<a href="/tag/vi" title="vi: 2 posts" class="size-1">vi</a>
<a href="/tag/viewsvn" title="viewsvn: 1 posts" class="size-0">viewsvn</a>
<a href="/tag/vmware" title="vmware: 1 posts" class="size-0">vmware</a>
<a href="/tag/vows" title="vows: 1 posts" class="size-0">vows</a>
<a href="/tag/wordpress" title="wordpress: 1 posts" class="size-0">wordpress</a>
<a href="/tag/zsh" title="zsh: 1 posts" class="size-0">zsh</a>
              </div>
              <h4>Archives</h4>
              <div id="archives" class="tagcloud"><a href="/archive.html" title="Total: 81 posts" class="size-25">Toutes</a>
<a href="/archive/2007" title="2007: 46 posts" class="size-25">2007</a>
<a href="/archive/2008" title="2008: 14 posts" class="size-11">2008</a>
<a href="/archive/2009" title="2009: 6 posts" class="size-4">2009</a>
<a href="/archive/2010" title="2010: 9 posts" class="size-7">2010</a>
<a href="/archive/2011" title="2011: 2 posts" class="size-1">2011</a>
<a href="/archive/2012" title="2012: 4 posts" class="size-3">2012</a>
              </div>
              <h4>Blogroll</h4>
              <li><a href="http://www.dviel.com/" target="_blank" class="ext">Damien Viel’s blog</a><span class="ext"></span></li>
              <li><a href="http://blogpro.toutantic.net/" target="_blank" class="ext">Aurélien Pelletier</a><span class="ext"></span></li>
              <li><a href="http://blog.aheritier.net/" target="_blank" class="ext">Le blog d"Arnaud</a><span class="ext"></span></li>
              <li><a href="http://blog.toutantic.net/" target="_blank" class="ext">Aurel"s blog</a><span class="ext"></span></li>
              <li><a href="http://blog.loof.fr/" target="_blank" class="ext">new Blog( perso );</a><span class="ext"></span></li>
              <li><a href="http://www.application-servers.com/" target="_blank" class="ext">a19s</a><span class="ext"></span></li>
              <li><a href="http://www.onirik.org/" target="_blank" class="ext">Onirik</a><span class="ext"></span></li>
              <li><a href="http://grumeautique.blogspot.com/" target="_blank" class="ext">Petit précis de Grumeautique</a><span class="ext"></span></li>
              <h4>Feeds</h4><a target="_blank" style="cursor:pointer;" href="http://feeds.feedburner.com/bazoud/feed"><img alt="Feed" title="Feed" src="/images/rss.png"/></a><a target="_blank" style="cursor:pointer;" href="http://feeds.feedburner.com/bazoud/comments"><img alt="Comments Feed" title="Comments Feed" src="/images/rss.png"/></a>
            </ul>
          </div>
        </div>
        <div class="span8">
          <div class="content">
            <div class="row">
              <div class="span12">
                <div class="page-header"><a href="/articles/2012-07-18-vagrant-createur-de-vm/">
                    <h1>Vagrant, créateur de VM</h1></a></div>
                <p id="post_top_meta1" class="muted"><span class="meta-prep meta-prep-author">Posté le </span><span class="entry-date">mercredi 18 juillet 2012</span> | <span class="meta-sep"> Ecrit par </span><span class="author vcard">Olivier</span> | <a href="/articles/2012-07-18-vagrant-createur-de-vm/">Lien permanent</a> | <a href="#disqus_thread">Commentaires</a> | Posté dans <a href="/category/Uncategorized" rel="category tag" title="View all posts in 'Uncategorized'">Uncategorized</a>&nbsp;
                </p>
                <hr/>
                <div class="post_content"><h2>Objectifs</h2>
<p>A cours d&apos;un projet IT, nous avons besoin de créer des serveurs, une base de données, un <a href="http://fr.wikipedia.org/wiki/Int%C3%A9gration_continue">serveur d&apos;intégration continue</a>,... Les outils de type <a href="http://en.wikipedia.org/wiki/Cloud_computing">Cloud</a> se démocratisent de plus en plus dans les entreprises pour construire des infrastructures virtuelles rapidemment. Mais le cloud sur la machine du développeur, c&apos;est pour quand ?

</p>
<p>Pour illustrer un cas d&apos;utilisation, nous utiliserons <a href="http://vagrantup.com/">Vagrant</a> pour créer une machine virtuelle (VM) contenant <a href="http://jenkins-ci.org/">Jenkins</a> et <a href="http://www.sonarsource.org">Sonar</a>.

</p>
<h2>Vagrant</h2>
<p><a href="http://vagrantup.com/">Vagrant</a> est un outil qui permet de configurer des VM <a href="https://www.virtualbox.org">VirtualBox</a> (<a href="https://twitter.com/mitchellh/status/222936445114003457">le support d&apos;autres types de VM est en cours</a>) et d&apos;utiliser des &quot;provisioner&quot; pour provisionner la VM créée, plusieurs sont à notre disposition:

</p>
<ul>
<li><a href="http://vagrantup.com/v1/docs/provisioners/shell.html">Shell Provisioner</a> permet d&apos;executer un shell</li>
<li><a href="http://puppetlabs.com">Puppet Server</a> <a href="http://vagrantup.com/v1/docs/provisioners/puppet_server.html">Provisioning</a> est un outil de gestion de configuration de serveurs </li>
<li><a href="http://docs.puppetlabs.com/man/apply.html">Puppet</a> <a href="http://vagrantup.com/v1/docs/provisioners/puppet.html">Provisioning</a> est utilisable sans Puppet server, en mode standalone</li>
<li><a href="http://www.opscode.com/chef">Chef Server</a> <a href="http://vagrantup.com/v1/docs/provisioners/chef_server.html">Provisioning</a> est un autre outil de gestion de configuration de serveurs</li>
<li><a href="http://wiki.opscode.com/display/chef/Chef+Solo">Chef Solo</a> <a href="http://vagrantup.com/v1/docs/provisioners/chef_solo.html">Provisioning</a> permet d&apos;exécuter <a href="http://www.opscode.com/chef">Chef</a> en l&apos;absence d&apos;un <a href="http://wiki.opscode.com/display/chef/Chef+Server">Chef server</a></li>
</ul>
<p>Il y a également la possibilité de <a href="http://vagrantup.com/v1/docs/provisioners/others.html">créer aussi votre propre provisoner</a>.
Dans la suite de l&apos;article, nous utiliserons <a href="http://wiki.opscode.com/display/chef/Chef+Solo">Chef Solo</a>.

</p>
<h2>Installation</h2>
<p>Installons <a href="https://www.virtualbox.org">VirtualBox</a> sur une Ubuntu 12.04 en 64 bits:

</p>
<pre class="prettyprint lang-bsh">
# wget <a href="http://download.virtualbox.org/virtualbox/4.1.18/virtualbox-4.1_4.1.18-78361~Ubuntu~precise_amd64.deb">http://download.virtualbox.org/virtualbox/4.1.18/virtualbox-4.1_4.1.18-78361~Ubuntu~precise_amd64.deb</a>
# dpkg -i virtualbox-4.1_4.1.18-78361~Ubuntu~precise_amd64.deb
</pre>

<p>Puis <a href="http://vagrantup.com/">Vagrant</a>, celui-ci étant écrit en ruby, il s&apos;installe via une gem:

</p>
<pre class="prettyprint lang-bsh">
% gem install vagrant
</pre>

<p>Dans <a href="http://vagrantup.com/">Vagrant</a>, nous installons une box <a href="http://releases.ubuntu.com/12.04/">Ubuntu &apos;Precise Pangolin&apos; 12.04 LTS</a> en version serveur déjà toute faite (avec par défaut un user &apos;vagant&apos; qui le droit de faire du sudo). Cette box <a href="http://www.ubuntu.com">Ubuntu</a> nous servira de base pour créer notre VM. Attention, le fichier pèse ~ 325 Mo, mais c&apos;est à faire qu&apos;une seule fois.

</p>
<pre class="prettyprint lang-bsh">
% vagrant box add precise64 <a href="http://files.vagrantup.com/precise64.box">http://files.vagrantup.com/precise64.box</a>
</pre>

<p>Finissons le paragraphe &quot;Installation&quot; avec <a href="https://github.com/dcestari/git-external">Git external</a> (voir l&apos;article <a href="/post/2012-07-11-conversion-en-masse-de-projets-svn-vers-git.html">Conversion en masse de projets SVN vers Git</a> pour plus de détail) qui permettra de gérer dans <a href="http://git-scm.com/">Git</a> facilement les recettes <a href="http://www.opscode.com/chef">Chef</a>. Une recette permet d&apos;effectuer des taches (par exemple: installer apache, mysql, ...).

</p>
<pre class="prettyprint lang-bsh">
% gem install git-external
</pre>

<p>Il ne reste qu&apos;à provisionner la VM avec les recettes <a href="http://jenkins-ci.org/">Jenkins</a> et <a href="http://www.sonarsource.org">Sonar</a>.

</p>
<h2>Création de la VM</h2>
<p>Nous créons un repository <a href="http://git-scm.com/">Git</a> pour sauvergarder notre tavail:

</p>
<pre class="prettyprint lang-bsh">
% git init &amp;&amp; git commit -m &quot;First commit&quot; --allow-empty
</pre>

<p>L&apos;initialisation de Vagrant se fait par la commande suivante:

</p>
<pre class="prettyprint lang-bsh">
% vagrant init precise64
</pre>

<p>Un fichier Vagrantfile est créé, c&apos;est un fichier de configuration, écrit en <a href="http://www.ruby-lang.org/">Ruby</a>, pour piloter la création de la VM, voici son <a href="https://gist.github.com/3136221">contenu initial</a>. Vous noterez que le nom de la box apparait sous la clé &quot;config.vm.box&quot;.

</p>
<p>Pour accèlécer le processus de la création de la VM, la mise en place du cache APT et Gem est recommandée, ça évite de télécharger Internet à chaque provisioning. C&apos;est assez simple à mettre en oeuvre, il ne faut pas hésiter! Cela se passe via les &quot;share_folder&quot; (à noter qu&apos;il faut créer ces répertoires sinon Vagrant ne démarre pas!). Un &quot;share_folder&quot; est un répertoire partagée entre votre machine (le host) et la VM (le guest).

</p>
<p>Un autre point intéressant, c&apos;est le port forwarding. Il vous permettra de d&apos;utiliser un port sur votre machine (le host) et il sera automatiquement transfèrer vers le port de la VM (le guest). Dans notre cas, nous pourrons utiliser en localhost le port 8080 pour voir <a href="http://jenkins-ci.org/">Jenkins</a> et le port 9000 pour <a href="http://www.sonarsource.org">Sonar</a>.

</p>
<pre class="prettyprint lang-ruby">
Vagrant::Config.run do |config|
  config.vm.box = &quot;precise64&quot;

  config.vm.share_folder &quot;v-apt-cache&quot;, &quot;/var/cache/apt/archives&quot;, &quot;~/tmp/vagrant/apt/cache&quot;
  config.vm.share_folder &quot;v-gem-cache&quot;, &quot;/opt/vagrant_ruby/lib/ruby/gems/1.8&quot;, &quot;~/tmp/vagrant/gems/1.8&quot;

  config.vm.forward_port 8080, 8080
  config.vm.forward_port 9000, 9000
  (...)
end
</pre>

<p>Le provisionning Shell, ici je l&apos;ai utilisé pour mettre à jour Chef avec la dernière version.
</p>
<pre class="prettyprint lang-ruby">
  config.vm.provision :shell, :path =&gt; &quot;update_chef.sh&quot;
</pre>

<p>L&apos;autre &quot;provisoner&quot; est <a href="http://wiki.opscode.com/display/chef/Chef+Solo">Chef Solo</a>. Commençons par récupérer les cookbooks, chouette ils sont tous sur <a href="https://github.com">Github</a> ;) Go Go <a href="https://github.com/dcestari/git-external">Git external</a>!

</p>
<pre class="prettyprint lang-bsh">
% git external add <a href="git://github.com/opscode-cookbooks/apt.git">git://github.com/opscode-cookbooks/apt.git</a> cookbooks/apt
% git external add <a href="git://github.com/opscode-cookbooks/java.git">git://github.com/opscode-cookbooks/java.git</a> cookbooks/java
% git external add <a href="git://github.com/opscode-cookbooks/openssl.git">git://github.com/opscode-cookbooks/openssl.git</a> cookbooks/openssl
% git external add <a href="git://github.com/bryanwb/chef-ark.git">git://github.com/bryanwb/chef-ark.git</a> cookbooks/ark
% git external add <a href="git://github.com/ctrabold/chef-sonar.git">git://github.com/ctrabold/chef-sonar.git</a> cookbooks/sonar
% git external add <a href="git://github.com/opscode-cookbooks/git.git">git://github.com/opscode-cookbooks/git.git</a> cookbooks/git
% git external add <a href="git://github.com/obazoud/mysql.git">git://github.com/obazoud/mysql.git</a> cookbooks/mysql develop
% git external add <a href="git://github.com/obazoud/chef-jenkins.git">git://github.com/obazoud/chef-jenkins.git</a> cookbooks/jenkins war
% git external init
</pre>

<p>Cette série de commande clone chaque repository dans le répertoire indiqué.
Il reste à déclarer l&apos;utilisation de ces cookbooks avec <strong>chef.add_recipe</strong> et leurs paramètrages via le <strong>chef.json</strong>:

</p>
<ul>
<li>Java 7 Oracle avec un mirroir local (10.0.2.2 est la machine host par défaut)</li>
<li>Jenkins 1.474 avec aussi un mirroir local</li>
<li>MySQL avec le mot de passe &quot;root&quot; et bindé sur 0.0.0.0</li>
<li>Sonar 3.1.1 avec un mirroir local, checksum et utilisation de MySQL comme base de données</li>
</ul>
<pre class="prettyprint lang-ruby">
  config.vm.provision :chef_solo do |chef|
    chef.cookbooks_path = &quot;cookbooks&quot;

    chef.add_recipe &quot;mysql::server&quot;
    chef.add_recipe &quot;git&quot;
    chef.add_recipe &quot;java&quot;
    chef.add_recipe &quot;jenkins&quot;
    chef.add_recipe &quot;sonar&quot;
    chef.add_recipe &quot;sonar::database_mysql&quot;

    chef.json = {
      :java =&gt; {
        :install_flavor =&gt; &quot;oracle&quot;,
        :jdk_version =&gt; &quot;7&quot;,
        :jdk =&gt; {
          &quot;7&quot; =&gt; {
            :x86_64 =&gt; {
              :url =&gt; &quot;<a href="http://10.0.2.2/chef/jdk-7u5-linux-x64.tar.gz">http://10.0.2.2/chef/jdk-7u5-linux-x64.tar.gz</a>&quot;,
              :checksum  =&gt; &quot;2a118ce9350d0c0cbaaeef286d04980df664b215d6aaf7bc1d4469abf05711bf&quot;
            }
          }
        }
      },
      :jenkins =&gt; {
        :mirror_url =&gt; &quot;<a href="http://10.0.2.2/chef/jenkins/war">http://10.0.2.2/chef/jenkins/war</a>&quot;,
        :version    =&gt; &quot;1.474&quot;,
        :checksum   =&gt; &quot;6ff0ce7c0426d12dd46f9a62e0a8b2a503862ac0d0c7ba687034d05fb884966e&quot;
      },
      :mysql =&gt; {
        :server_debian_password =&gt; &quot;root&quot;,
        :server_root_password =&gt; &quot;root&quot;,
        :server_repl_password =&gt; &quot;root&quot;,
        :bind_address =&gt; &quot;0.0.0.0&quot;
      },
      :sonar =&gt; {
        :mirror    =&gt; &quot;<a href="http://10.0.2.2/chef/sonar">http://10.0.2.2/chef/sonar</a>&quot;,
        :version   =&gt; &quot;3.1.1&quot;,
        :checksum  =&gt; &quot;9606c6f6c79c6b944d9d4a7c5eb6531b&quot;,
        :os_kernel =&gt; &quot;linux-x86-64&quot;,
        :jdbc_url =&gt; &quot;jdbc:<a href="mysql://localhost:3306/sonar">mysql://localhost:3306/sonar</a>&quot;,
        :jdbc_driverClassName =&gt; &quot;com.mysql.jdbc.Driver&quot;,
        :jdbc_validationQuery =&gt; &quot;select 1&quot;
      }
    }
  end
</pre>

<p>La version complète de <a href="https://github.com/obazoud/vagrant-ci/blob/master/Vagrantfile">Vagrantfile est dans Github</a>.

</p>
<p>La configuration étant finie, nous pouvons lancer les commandes création de la VM.

</p>
<h2>Vagrant up!</h2>
<p>Voici quelques commandes utiles <a href="http://vagrantup.com/">Vagrant</a>:

</p>
<ul>
<li>Supprime l&apos;ancienne VM créée et démarre la VM en effectueant le provionning<pre class="prettyprint lang-bsh">
% vagrant destroy --force
% vagrant up
</pre></li>
<li>Relance uniquement le provionning (la VM reste up)<pre class="prettyprint lang-bsh">
% vagrant provision
</pre></li>
<li>Se logger en ssh à la VM<pre class="prettyprint lang-bsh">
# Ajout de la clé ssh de vagrant dans votre agent 
# Le chemin de cette clé dépend de votre installation
% ssh-add ~/.rvm/gems/ruby-1.8.7-p358/gems/vagrant-1.0.3/keys/vagrant
% vagrant ssh
</pre></li>
<li>Arrêt correctement la VM<pre class="prettyprint lang-bsh">
% vagrant halt
</pre></li>
<li>Arrêt la VM<pre class="prettyprint lang-bsh">
% vagrant halt --force
</pre>

</li>
</ul>
<p>Vous pouvez maintenant accèder à:

</p>
<ul>
<li><a href="http://jenkins-ci.org/">Jenkins</a> sur cette url <a href="http://localhost:8080">http://localhost:8080</a></li>
<li><a href="http://www.sonarsource.org">Sonar</a> en tapant <a href="http://localhost:9000">http://localhost:9000</a> (patienter un peu que <a href="http://www.sonarsource.org">Sonar</a> puisse créer la structure de la base de données ~ 10 à 30s suivant votre machine)</li>
</ul>
<p>A noter qu&apos;avec le même fichier Vagrantfile, il est possible de créer et de provisonner plusieurs VM.

</p>
<h2>Conclusion</h2>
<p>Nous avons mis en oeuvre la création d&apos;une machine virtuelle (VM) contenant <a href="http://jenkins-ci.org/">Jenkins</a> et <a href="http://www.sonarsource.org">Sonar</a> directement sur le poste du développeur. <a href="http://vagrantup.com/">Vagrant</a> et <a href="http://www.opscode.com/chef">Chef</a> permettent de créer et d&apos;installer via des recettes les logiciels souhaitées. <a href="https://github.com/opscode-cookbooks">La plupart des recettes existent déjà</a> pour les logiciels communs (apt, apache2, nginx, mysql, ntp, python, php, ...). A vous de jouer maintenant!

</p>
<p>Tout le code source se trouve sur GitHub: <a href="https://github.com/obazoud/vagrant-ci"><a href="https://github.com/obazoud/vagrant-ci">https://github.com/obazoud/vagrant-ci</a></a>.
</p>

                </div>
                <hr/>
                <p id="post_top_meta1" class="muted"><span class="meta-prep meta-prep-author">Posté le </span><span class="entry-date">mercredi 18 juillet 2012</span> | <span class="meta-sep"> Ecrit par </span><span class="author vcard">Olivier</span> | <a href="/articles/2012-07-18-vagrant-createur-de-vm/">Lien permanent</a> | <a href="#disqus_thread">Commentaires</a> | Posté dans <a href="/category/Uncategorized" rel="category tag" title="View all posts in 'Uncategorized'">Uncategorized</a>&nbsp;
                </p>
                <p id="post_bottom_meta2" class="muted">Taggé avec: <a href="/tag/vagrant" rel="category tag" title="View all posts in 'vagrant'">vagrant</a>&nbsp;<a href="/tag/devops" rel="category tag" title="View all posts in 'devops'">devops</a>&nbsp;<a href="/tag/ruby" rel="category tag" title="View all posts in 'ruby'">ruby</a>&nbsp;<a href="/tag/git" rel="category tag" title="View all posts in 'git'">git</a>&nbsp;<a href="/tag/opschef" rel="category tag" title="View all posts in 'opschef'">opschef</a>&nbsp;<a href="/tag/puppet" rel="category tag" title="View all posts in 'puppet'">puppet</a>&nbsp;<a href="/tag/jenkins" rel="category tag" title="View all posts in 'jenkins'">jenkins</a>&nbsp;<a href="/tag/sonar" rel="category tag" title="View all posts in 'sonar'">sonar</a>&nbsp;<a href="/tag/cloud" rel="category tag" title="View all posts in 'cloud'">cloud</a>&nbsp;
                </p>
                <div id="social_bottom" class="topsocial">
                  <div class="social"><a href="/post/2012-07-18-vagrant-createur-de-vm.html" data-url="http://blog.bazoud.com/post/2012-07-18-vagrant-createur-de-vm.html" data-text="Vagrant, créateur de VM #vagrant #devops #ruby #git #opschef #puppet #jenkins #sonar #cloud /via @obazoud" data-count="vertical" class="twitter-share-button">
                      <twitter-share-button></twitter-share-button></a><script type="text/javascript" src="//platform.twitter.com/widgets.js"></script>
                  </div>
                  <div class="social"><g:plusone size="tall" href="http://blog.bazoud.com/post/2012-07-18-vagrant-createur-de-vm.html"></g:plusone></div>
                  <div class="social">
                    <script src="http://platform.linkedin.com/in.js" type="text/javascript"></script>
                    <script type="IN/Share" data-url="http://blog.bazoud.com/post/2012-07-18-vagrant-createur-de-vm.html" data-counter="top"></script>
                  </div>
                  <div class="social">
                    <div class="share-delicious">
                      <div id="delic" class="delicious">0</div>
                      <div id="delicious-b"><a href="http://del.icio.us/post?url=http://blog.bazoud.com/post/2012-07-18-vagrant-createur-de-vm.html&amp;title=&quot;Save To Delicious&quot;" target="blank">delicious</a></div>
                    </div> <script type='text/javascript'>
                     function delic(info) {
                      if(!info[0]) return;
                      var num = info[0].total_posts;
                       if(!num) return;
                       var delic = document.getElementById('delic');
                       delic.innerHTML = '' + num;
                       delic.style.textIndent = 0;
                       delic.style.paddingRight= '6px';
                     }
                     </script>
                     <script src='http://badges.del.icio.us/feeds/json/url/data?url=http://blog.bazoud.com/post/2012-07-18-vagrant-createur-de-vm.html'&callback=declic></script>
                  </div>
                </div><script type="text/javascript">
                  (function() {
                    var po = document.createElement('script'); po.type = 'text/javascript'; po.async = true;
                    po.src = 'https://apis.google.com/js/plusone.js';
                    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(po, s);
                  })();
                </script>
                <hr/>
                <h3>Articles similaires</h3>
                <table class="table table-striped">
                  <tbody>
                    <tr>
                      <td><a href="/articles/2011-11-02-ce-blog-change-de-technos/" title="git,nodejs,javascript,coffeescript,heroku,docpad,twitter,phantomjs,vows,bdd,wordpress">Ce blog change de technos</a></td>
                    </tr>
                    <tr>
                      <td><a href="/articles/2010-05-04-git-et-ubuntu/" title="Ubuntu,git,ppa">Git et ubuntu</a></td>
                    </tr>
                    <tr>
                      <td><a href="/articles/2012-07-18-vagrant-createur-de-vm/" title="vagrant,devops,ruby,git,opschef,puppet,jenkins,sonar,cloud">Vagrant, créateur de VM</a></td>
                    </tr>
                    <tr>
                      <td><a href="/articles/2010-12-11-migration-de-svn-vers-git-en-4-etapes/" title="svn,awk,shell,git,subversion,grep">Migration de SVN vers GIT en 4 étapes</a></td>
                    </tr>
                    <tr>
                      <td><a href="/articles/2012-07-11-conversion-en-masse-de-projets-svn-vers-git/" title="git,svn,ruby,bash,gem,svn2git">Conversion en masse de projets SVN vers Git</a></td>
                    </tr>
                  </tbody>
                </table>
                <h3>Commentaires</h3>
                <div id="disqus_thread"></div><script type="text/javascript">
                var disqus_shortname = 'bazoud';
                (function() {
                   var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
                   dsq.src = 'http://' + disqus_shortname + '.disqus.com/embed.js';
                   (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
                })();
                </script>
                <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
                <a href="http://disqus.com" class="dsq-brlink">blog comments powered by <span class="logo-disqus">Disqus</span></a>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
    <footer class="footer">
      <div class="inner">
        <p class="pull-right"><a href="#">Revenir en haut</a></p>
        <p>
           
          Le blog d'Olivier - Copyright © 2007-2012  Olivier Bazoud - Powered by <a href="http://www.nodejs.org" title="Powered by Node.js" target="_blank">Node.js</a> and<a href="https://github.com/jnordberg/wintersmith" title="Powered by Wintersmith" target="_blank"> Wintersmith </a> - Special thanks to <a href="http://twitter.github.com/bootstrap/" target="_blank" title="Bootstrap, from Twitter">Twitter Bootstrap</a>
        </p>
      </div>
    </footer><script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-1176603-1']);
     
    _gaq.push(['_trackPageview']);
     
    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
    </script>
  </body>
</html>